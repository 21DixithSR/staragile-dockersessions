Configuration Management with Ansible:
====================================

Configuration:

Making changes to your environment like:
 - creating files, directories
 - copying files form system to other 
 - creation of users and giving permissions to them
 - Installation/upgrade/uninstallation of packages
 - Deploying of applications
 - creating Db, tables

In an organization there can be many environment (set of VMs) like dev, Qa, prod

Configuration changes can be done manually or automatically - Configuration Management

If we have to do changes on all environments manually :
	- time consuming
	- repetitive
	- Boring
	- prone human errors
	- effort and expensive

When working in DevOps we want to deliver/deploy an application at a faster rate 
When working in DevOps we have to avoid any manual task
When working in DevOps Configuration management on the servers should also be automated
This can be automated using CM tools 
- Ansible
- puppet
- chef
- saltstack

Ansible:
===================

Ansible is a CM tool
It is an open source tool
It works on push approach-> ansible pushes the configuration changes on the worker machines
Ansible is product of RedHat, now its taken over by IBM
Ansible will always be installed on a Linux machine
Ansible will connect to Linux/windows machine for doing configuration changes
Ansible is very easy to learn tool
Ansible has 2 parts: Ansible Core and Ansible tower
Ansible Core : it is the command line tool where we run ansible commands
Ansible tower: it is the GUI of ansible -> it is available with ansible enterprise version, however a trial version is available for use
We will be learning Ansible Core
Ansible code is written in YAML - and the file is called as playbook

Ansible Components:
====================

1. Inventory: WHERE TO DO THE CONFIGURATION CHANGES
====================
- it is a simple text file
- it is present by default in the directory /etc/ansible
- Name of the file by default is hosts
- you can give any other name to the file
- In this file we will write Ip address or hostnames of the servers that ansible has to connect to do changes

2. MODULES: What CHANGES TO DO
===========================
Modules are small python programs pre-written and provided to you by Ansible
There are 4000+ modules
for any configuration tasks that we want to automate, ansible gives a modules 
To this module you give some input values
The module is executed on the worker machine and the required configuration changes are present on worker machine
Each module will do a specific task based on the input values that you provide

Example:
==================

command module: this module will execute any command on your worker machine

ansible --> command(echo "hello All") => 

copy module -. the module has the logic to copy files form source to destination

ansible --> copy(src/file, dest/file)



java:

method:

add(a,b)
{
   result = a+b;
   return(result);

}


file.java
{

method.add(100,20)  ==> 120


}

3. Playbooks:
==========================

Anisble code is written in playbooks
Playbook are written in YAML
A playbook consists of 2 things:

hosts:  
  workers machine that we have to connect, these worker machine IP address should be in inventory file
tasks:
   modules to be executed on the worker machine 


When the playbook is executed 
playbook --> is converted to a python program --> this python file is copied using SSH on the desired worker machine
This python code is then executed by ansible on the worker machine -->
After python file has been executed , it is deleted from the worker machine
All the details can be seen on the ansible controller machine.

4. ansible.cfg

This is ansible configuration file
The name of the file will always be ansible.cfg
The file is present by default in /etc/ansible
You can create the file in any location
In this file we have complete details about ansible
- location of modules
- location on inventory
- user details
- forks
- ansible plugin details


Ansible Installation:
=====================

# sudo su -
$ sudo apt update
$ sudo apt install software-properties-common
$ sudo add-apt-repository --yes --update ppa:ansible/ansible
$ sudo apt install ansible

On the MAster node -> generate the SSH keys
# ssh-keygen

Copy the public ssh key

# cat /root/.ssh/id_rsa.pub


GO TO the worker NODE now

# sudo su -

# echo "<your public key>" >> authorized_keys 

Now go back to Master and update the inventory file

# cd /etc/ansible

# vim hosts


[webserver]
<privateIp of worker>


save the file

run ansible adhoc commands

# ansible weberver -m ping


















Demo:
====================
Ansible code is written in 2 ways:

1. Ansible Ad hoc command

single line command
only 1 module will be executed
only 1 task will be performed on worker
it should be used when we want to quickly check something on the worker node

Syntax :
===========

ansible [hostgroup] -m [modulename] -a [argument/input]

===============================================================
Playbook:

# vim playbook1.yml

---
- name: A playbook to print a message
  hosts: webserver
  tasks:
  - name: Print a message
    debug: msg="Hello from Ansible Controller"
  - name: Execute a command
    command: hostname -s


# ansible-playbook playbook1.yml

# vim playbook2.yml

---
- name: Store the output of a task and print the output
  hosts: webserver
  tasks:
  - name: Exeucte a command
    command: hostname -s
    register: output_command   # it is a variable registering the output of command module
  - name: Print the variable value
    debug: var=output_command

# ansible-playbook playbook2.yml


# vim playbook3.yml

---
- name: Install packages on worker
  hosts: webserver
  tasks:
  - name: Update apt repo
    command: apt-get update
  - name: Install apache2 package
    package: name=apache2 state=present
  - name: Start apache2 service
    service: name=apache2 state=started

# ansible-playbook playbook3.yml

 # vim playbook4.yml

---
- name: Install multiple packages
  hosts: webserver
  tasks:
  - name: Install mutliple package
    package: name={{ item }}  state=present
    loop:
     - php
     - nano
     - git
     - docker.io
     - maven

# ansible-playbook playbook4.yml


# vim htmldeployment.yml

---
- name: Deploy HTML code on Apche2 server
  hosts: webserver
  tasks:
  - name: Print the start of deployment
    debug: msg="Deployment started..."
  - name: Install package
    package: name=apache2 state=present
  - name: Check apache is installed or not
    command: apache2 -v
    register: output_var
  - name: Print the version of apache2
    debug: var=output_var
  - name: Copy HTML code on apache2 server
    copy: src=index.html dest=/var/www/html
  - name: Print status of code file
    debug: msg="index.html file copied successfully .."
  - name: Restart apache2
    service: name=apache2 state=restarted
  - name: Status of Deployment
    debug: msg="Deployment completed .."


# vim index.html

index.html

<h1> This code file is from Ansible Contorller </h1>
<h2> This file is created by Sonal </h2>
<h2> We are learning Ansible as configuration mamanagement tool </h2>


























